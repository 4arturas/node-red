<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Shallow Agent Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/antd/5.26.5/reset.min.css"/>
    <style>
        body {
            padding: 30px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        #chat-container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            height: 80vh;
        }
        #messages {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #d9d9d9;
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 4px;
            background-color: #fafafa;
        }
        .message {
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
        }
        .user-message {
            background-color: #e6f7ff;
            margin-left: auto;
            text-align: right;
        }
        .agent-message {
            background-color: #f6ffed;
        }
        #input-container {
            display: flex;
            gap: 8px;
        }
        #message-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }
        #send-button {
            padding: 8px 16px;
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #send-button:disabled {
            background-color: #bfbfbf;
            cursor: not-allowed;
        }
        .status {
            margin-top: 8px;
            font-size: 12px;
            color: #8c8c8c;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/antd/5.26.7/antd.min.js"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function ChatApp() {
        const [messages, setMessages] = useState([]);
        const [inputValue, setInputValue] = useState('');
        const [isConnected, setIsConnected] = useState(false);
        const [isLoading, setIsLoading] = useState(false);
        const ws = useRef(null);
        const messagesEndRef = useRef(null);

        const scrollToBottom = () => {
            messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
        };

        useEffect(() => {
            scrollToBottom();
        }, [messages]);

        useEffect(() => {
            // Connect to WebSocket
            ws.current = new WebSocket('ws://127.0.0.1:1880/ws/shallow-agent');

            ws.current.onopen = () => {
                console.log('Connected to Shallow Agent WebSocket');
                setIsConnected(true);
            };

            ws.current.onmessage = (event) => {
                const response = event.data;
                setMessages(prev => [...prev, { 
                    id: Date.now(), 
                    text: response, 
                    sender: 'agent',
                    timestamp: new Date().toLocaleTimeString()
                }]);
                setIsLoading(false);
            };

            ws.current.onclose = () => {
                console.log('Disconnected from Shallow Agent WebSocket');
                setIsConnected(false);
            };

            ws.current.onerror = (error) => {
                console.error('WebSocket error:', error);
                setIsConnected(false);
                setIsLoading(false);
            };

            // Clean up on unmount
            return () => {
                if (ws.current) {
                    ws.current.close();
                }
            };
        }, []);

        const handleSend = () => {
            if (inputValue.trim() === '' || !isConnected || isLoading) return;

            // Add user message to UI immediately
            const userMessage = {
                id: Date.now(),
                text: inputValue,
                sender: 'user',
                timestamp: new Date().toLocaleTimeString()
            };
            setMessages(prev => [...prev, userMessage]);
            
            // Send to WebSocket
            ws.current.send(inputValue);
            setInputValue('');
            setIsLoading(true);
        };

        const handleKeyPress = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        };

        return (
            <div id="chat-container">
                <h2>ðŸ¤– Shallow Agent Chat</h2>
                <div id="messages">
                    {messages.map((msg) => (
                        <div key={msg.id} className={`message ${msg.sender}-message`}>
                            <div><strong>{msg.sender === 'user' ? 'You' : 'Agent'}:</strong> {msg.text}</div>
                            <div className="timestamp" style={{fontSize: '10px', color: '#8c8c8c', marginTop: '4px'}}>
                                {msg.timestamp}
                            </div>
                        </div>
                    ))}
                    {isLoading && (
                        <div className="message agent-message">
                            <div><strong>Agent:</strong> Thinking...</div>
                        </div>
                    )}
                    <div ref={messagesEndRef} />
                </div>
                
                <div id="input-container">
                    <input
                        id="message-input"
                        type="text"
                        value={inputValue}
                        onChange={(e) => setInputValue(e.target.value)}
                        onKeyPress={handleKeyPress}
                        placeholder="Type your message here..."
                        disabled={!isConnected || isLoading}
                    />
                    <button
                        id="send-button"
                        onClick={handleSend}
                        disabled={!isConnected || isLoading || inputValue.trim() === ''}
                    >
                        Send
                    </button>
                </div>
                
                <div className="status">
                    Status: <span style={{color: isConnected ? 'green' : 'red'}}>{isConnected ? 'Connected' : 'Disconnected'}</span>
                    {isLoading && ' | Processing...'}
                </div>
            </div>
        );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<ChatApp />);
</script>
</body>
</html>