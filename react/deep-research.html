<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Deep Research Agent</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/antd/5.26.5/reset.min.css"/>
    <style>
        body {
            padding: 30px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        #container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }
        #data-display {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #d9d9d9;
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 4px;
            background-color: #fafafa;
        }
        .json-object {
            margin-bottom: 16px;
            padding: 12px;
            border-radius: 8px;
            background-color: #f9f9f9;
            border-left: 4px solid #1890ff;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .status {
            margin-top: 8px;
            font-size: 12px;
            color: #8c8c8c;
        }
        .controls {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        button {
            padding: 8px 16px;
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #bfbfbf;
            cursor: not-allowed;
        }
        #clear-button {
            background-color: #ff4d4f;
        }
        #clear-button:hover {
            background-color: #ff7875;
        }
        h2 {
            color: #1890ff;
            border-bottom: 2px solid #1890ff;
            padding-bottom: 8px;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/antd/5.26.7/antd.min.js"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const t = {"tool":"ConductResearch","arg":"Mission District analysis..."};

    function DeepResearchApp() {
        const [jsonData, setJsonData] = useState([]);
        const [isConnected, setIsConnected] = useState(false);
        const [connectionError, setConnectionError] = useState(null);
        // const [inputValue, setInputValue] = useState('');
        // const [inputValue, setInputValue] = useState('I want to research coffee shops in San Francisco.');
        const [inputValue, setInputValue] = useState('I want to konw what is ko ko ko.');
        const ws = useRef(null);
        const dataEndRef = useRef(null);

        const scrollToBottom = () => {
            dataEndRef.current?.scrollIntoView({ behavior: 'smooth' });
        };

        const handleSend = () => {
            if (inputValue.trim() === '' || !isConnected) return;

            // Send the query to WebSocket
            ws.current.send(JSON.stringify({ query: inputValue }));
            setInputValue('');
        };

        const handleKeyPress = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        };

        useEffect(() => {
            scrollToBottom();
        }, [jsonData]);

        useEffect(() => {
            // Connect to WebSocket
            ws.current = new WebSocket('ws://127.0.0.1:1880/ws/deep-research');

            ws.current.onopen = () => {
                console.log('Connected to Deep Research WebSocket');
                setIsConnected(true);
                setConnectionError(null);
            };

            ws.current.onmessage = (event) => {
                try {
                    // Attempt to parse the received data as JSON
                    const parsedData = JSON.parse(event.data);
                    
                    // Add timestamp to the received data in YYYY-MM-DD HH:MM:SS format using dayjs
                    const formattedDateTime = dayjs().format('YYYY-MM-DD HH:mm:ss');
                    
                    const dataWithTimestamp = {
                        ...parsedData,
                        timestamp: formattedDateTime,
                        id: Date.now()
                    };
                    
                    setJsonData(prev => [...prev, dataWithTimestamp]);
                } catch (error) {
                    // If parsing fails, store the raw data with formatted timestamp using dayjs
                    const formattedDateTime = dayjs().format('YYYY-MM-DD HH:mm:ss');
                    
                    const rawData = {
                        raw: event.data,
                        timestamp: formattedDateTime,
                        id: Date.now(),
                        error: 'Failed to parse as JSON'
                    };
                    setJsonData(prev => [...prev, rawData]);
                }
            };

            ws.current.onclose = () => {
                console.log('Disconnected from Deep Research WebSocket');
                setIsConnected(false);
                setConnectionError('WebSocket connection closed');
            };

            ws.current.onerror = (error) => {
                console.error('WebSocket error:', error);
                setIsConnected(false);
                setConnectionError('WebSocket connection error occurred');
            };

            // Clean up on unmount
            return () => {
                if (ws.current) {
                    ws.current.close();
                }
            };
        }, []);

        const handleClear = () => {
            setJsonData([]);
        };

        const formatJsonDisplay = (obj) => {
            // Format the JSON object for display
            return JSON.stringify(obj, null, 2);
        };

        return (
            <div id="container">
                <h2>ðŸ”¬ Deep Research Agent Data Stream</h2>
                
                <div className="controls">
                    <button 
                        id="clear-button" 
                        onClick={handleClear}
                        disabled={jsonData.length === 0}
                    >
                        Clear Data
                    </button>
                </div>

                <div style={{display: 'flex', gap: '8px', marginBottom: '16px'}}>
                    <input
                        type="text"
                        value={inputValue}
                        onChange={(e) => setInputValue(e.target.value)}
                        onKeyPress={handleKeyPress}
                        placeholder="Enter your research query here..."
                        disabled={!isConnected}
                        style={{
                            flex: 1,
                            padding: '8px 12px',
                            border: '1px solid #d9d9d9',
                            borderRadius: '4px',
                            fontSize: '14px'
                        }}
                    />
                    <button
                        onClick={handleSend}
                        disabled={!isConnected || inputValue.trim() === ''}
                        style={{
                            padding: '8px 16px',
                            backgroundColor: '#52c41a',
                            color: 'white',
                            border: 'none',
                            borderRadius: '4px',
                            cursor: 'pointer'
                        }}
                    >
                        Send Query
                    </button>
                </div>

                <div id="data-display">
                    {jsonData.map((item) => (
                        <div key={item.id} className="json-object">
                            <div style={{fontWeight: 'bold', marginBottom: '8px', color: '#535353'}}>
                                ðŸ“… {item.timestamp}
                            </div>
                            <pre style={{margin: 0, padding: '8px', backgroundColor: '#ffffff', borderRadius: '4px'}}>
                                {formatJsonDisplay(item)}
                            </pre>
                        </div>
                    ))}
                    {jsonData.length === 0 && (
                        <div style={{textAlign: 'center', color: '#8c8c8c', fontStyle: 'italic', padding: '20px'}}>
                            Waiting for data from Deep Research Agent...
                        </div>
                    )}
                    <div ref={dataEndRef} />
                </div>

                <div className="status">
                    Status: <span style={{color: isConnected ? 'green' : 'red'}}>{isConnected ? 'Connected' : 'Disconnected'}</span>
                    {connectionError && <span style={{marginLeft: '10px', color: 'red'}}>Error: {connectionError}</span>}
                </div>
            </div>
        );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<DeepResearchApp />);
</script>
</body>
</html>